# 書き起こしJSON修正ツール

書き起こしJSONファイルの誤字・表記ゆれを一括修正するツールです。

## 📦 ファイル構成

```
data/
  corrections.json          # 修正辞書（誤字と正しい表記のリスト）
  transcripts/              # 書き起こしJSONファイル
    ep1.0.1.json
    ep1.0.2.json
    ...
  transcripts_backup/       # バックアップフォルダ（自動生成）
fix_transcripts.py          # 修正スクリプト
```

---

## 🚀 使い方

### 1. 修正辞書の編集

`data/corrections.json`に修正ルールを追加します：

```json
{
  "corrections": [
    {
      "wrong": "石井さん",
      "correct": "石井",
      "description": "「さん」付けを削除",
      "enabled": true
    },
    {
      "wrong": "Code for Japna",
      "correct": "Code for Japan",
      "description": "スペルミス修正",
      "enabled": true
    }
  ]
}
```

#### フィールド説明

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `wrong` | ✅ | 誤った表記 |
| `correct` | ✅ | 正しい表記 |
| `description` | ✅ | 修正内容の説明（ログ用） |
| `enabled` | ⭕ | このルールを有効にするか（デフォルト: true） |

### 2. スクリプトの実行

#### 【推奨】コマンドライン引数で直接指定

辞書ファイルを編集せず、コマンドライン引数で直接置換を指定できます。

```bash
# 1つの置換
python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣" --dry-run

# 複数の置換
python scripts/fix_transcripts.py --episode 1.0.18 \
  --wrong "おまた" --correct "小俣" \
  --wrong "また：" --correct "小俣" \
  --dry-run

# 実行（--dry-runを外す）
python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣"
```

⚠️ **Windows PowerShellでの注意**:
日本語の引数を使用する場合、エンコーディングエラーが発生することがあります。
その場合は、辞書ファイル方式を使用するか、以下のように実行してください：

```powershell
# UTF-8エンコーディングを設定してから実行
$env:PYTHONIOENCODING="utf-8"
python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣" --dry-run
```

**メリット:**
- ✅ 辞書ファイルのメンテナンス不要
- ✅ その場で確認しながら修正
- ✅ 意図しない一括置換を防げる
- ✅ 特定のエピソードに特化した修正が簡単

#### 辞書ファイルを使用（従来の方法）

`data/corrections.json`に修正ルールを登録して使用：

```bash
# エピソード番号を指定
python scripts/fix_transcripts.py --episode 1.0.18

# ドライランで確認
python scripts/fix_transcripts.py --episode 1.0.18 --dry-run
```

#### 辞書ファイルとコマンドライン引数を併用

```bash
# 両方の修正ルールを使用
python scripts/fix_transcripts.py --episode 1.0.18 \
  --wrong "特定の誤字" --correct "正しい字" \
  --use-dict
```

#### 全ファイルを一括修正（注意）

```bash
# 必ず --all フラグが必要（辞書ファイル使用）
python scripts/fix_transcripts.py --all

# ドライランで確認（推奨）
python scripts/fix_transcripts.py --all --dry-run
```

⚠️ **注意**: `--all`を指定すると全ファイルが対象になり、確認プロンプトが表示されます。

---

## 📝 実行例

### コマンドライン引数で直接指定（推奨）

```bash
$ python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣" --dry-run

============================================================
書き起こしJSON修正スクリプト
============================================================

[INFO] コマンドライン引数から修正ルールを作成
  - おまた → 小俣

[INFO] 合計 1件の修正ルールを使用します

[INFO] エピソード 1.0.18 を処理します

[DRY-RUN] 実際にはファイルを変更しません


[DRY-RUN] 処理中: ep1.0.18.json
  [transcript] 2件の修正を適用
  → 合計 2件の修正
  ℹ DRY-RUNモード: ファイルは変更されません

============================================================
[完了] 1/1件のファイルを確認しました

実際に修正する場合は、--dry-run を外して実行してください
============================================================
```

### 辞書ファイルを使用

```bash
$ python scripts/fix_transcripts.py --episode 1.0.18 --dry-run

============================================================
書き起こしJSON修正スクリプト
============================================================

[INFO] 3件の修正ルールを読み込みました
  - 石井さん → 石井 (「さん」付けを削除)
  - 太田さん → 太田 (「さん」付けを削除)
  - 小俣さん → 小俣 (「さん」付けを削除)

[INFO] エピソード 1.0.18 を処理します

[DRY-RUN] 実際にはファイルを変更しません

[DRY-RUN] 処理中: ep1.0.18.json
  [transcript] 3件の修正を適用
  → 合計 3件の修正
  ℹ DRY-RUNモード: ファイルは変更されません

============================================================
[完了] 1/1件のファイルを確認しました

実際に修正する場合は、--dry-run を外して実行してください
============================================================
```

### 実際に修正

```bash
$ python scripts/fix_transcripts.py --episode 1.0.18

============================================================
書き起こしJSON修正スクリプト
============================================================

[INFO] 3件の修正ルールを読み込みました
  - 石井さん → 石井 (「さん」付けを削除)
  - 太田さん → 太田 (「さん」付けを削除)
  - 小俣さん → 小俣 (「さん」付けを削除)

[INFO] エピソード 1.0.18 を処理します

処理中: ep1.0.18.json
  📦 バックアップ作成: ep1.0.18_20260111_143025.json
  [transcript] 3件の修正を適用
  → 合計 3件の修正
  ✓ 保存完了

============================================================
[完了] 1/1件のファイルを修正しました

バックアップ: data/transcripts_backup/
============================================================
```

### 全ファイルを一括修正

```bash
$ python scripts/fix_transcripts.py --all

============================================================
書き起こしJSON修正スクリプト
============================================================

[INFO] 3件の修正ルールを読み込みました
  - 石井さん → 石井 (「さん」付けを削除)
  - 太田さん → 太田 (「さん」付けを削除)
  - 小俣さん → 小俣 (「さん」付けを削除)

[WARNING] 全 18 ファイルを処理します

本当に全ファイルを修正しますか？ (yes/no): yes

処理中: ep1.0.1.json
  📦 バックアップ作成: ep1.0.1_20260111_143025.json
  [transcript] 2件の修正を適用
  → 合計 2件の修正
  ✓ 保存完了

...

============================================================
[完了] 17/18件のファイルを修正しました

バックアップ: data/transcripts_backup/
============================================================
```

---

## 🎯 修正対象のフィールド

以下のフィールドが自動的に修正されます：

- `sub_title` - サブタイトル
- `detailed_description` - 詳細説明
- `summary` - 要約
- `transcript` - 全文書き起こし

`episode_number`と`file_name`は修正されません。

---

## 💡 使用例

### よくある修正パターン

#### 1. 敬称の削除

```json
{
  "wrong": "石井さん",
  "correct": "石井",
  "description": "「さん」付けを削除",
  "enabled": true
}
```

#### 2. スペルミスの修正

```json
{
  "wrong": "Code for Japna",
  "correct": "Code for Japan",
  "description": "スペルミス修正",
  "enabled": true
}
```

#### 3. 表記ゆれの統一

```json
{
  "wrong": "シビックテック",
  "correct": "シビックテック",
  "description": "全角カタカナに統一",
  "enabled": true
}
```

#### 4. 一時的に無効化

```json
{
  "wrong": "旧表記",
  "correct": "新表記",
  "description": "テスト中",
  "enabled": false
}
```

---

## ⚠️ 注意事項

### 1. バックアップについて

- 修正前に自動的にバックアップが作成されます
- バックアップは `data/transcripts_backup/` に保存されます
- ファイル名に日時が付加されます（例: `ep1.0.1_20260111_143025.json`）

### 2. 修正の注意点

- **完全一致のみ**: 部分一致ではなく、完全一致で置換されます
  - 例: `"wrong": "石井"` は `"石井さん"` にはマッチしません
- **大文字小文字を区別**: `"Code"` と `"code"` は別物として扱われます
- **順序が重要**: 修正は配列の順番で適用されます

### 3. 推奨ワークフロー

#### パターン1: コマンドライン引数で即座に修正（推奨）

```
1. 誤字を発見（例: ep1.0.18に「おまた」→「小俣」）
   ↓
2. ドライランで確認
   python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣" --dry-run
   ↓
3. 問題なければ実行
   python scripts/fix_transcripts.py --episode 1.0.18 --wrong "おまた" --correct "小俣"
```

✅ **メリット**: 辞書ファイル不要、その場で完結、意図しない置換なし

#### パターン2: 辞書ファイルで管理（頻繁に使う修正）

```
1. 頻繁に使う誤字パターンを発見
   ↓
2. data/corrections.json に追加
   ↓
3. 次回以降、自動的に適用
   python scripts/fix_transcripts.py --episode 1.0.XX
```

✅ **メリット**: 毎回同じ修正を指定する手間が省ける

⚠️ **重要**: 誤修正を防ぐため、必ずエピソード番号を指定してください。

---

## 🔧 transcribe_podcast.py との連携

新しく書き起こしを作成する際に、自動的に修正を適用することもできます。

`transcribe_podcast.py`の最後に以下を追加：

```python
# 書き起こし完了後、自動修正を適用
import subprocess
subprocess.run(["python", "fix_transcripts.py", "--file", output_filename])
```

---

## 📊 トラブルシューティング

### 問題: 修正が適用されない

**原因**: 表記が完全一致していない

**解決策**: 
- JSONファイル内の実際の表記を確認
- corrections.jsonの`wrong`を正確に記述

### 問題: 意図しない箇所も修正される

**原因**: 置換文字列が短すぎる

**解決策**:
- より具体的な文字列を指定
- または、手動で修正

### 問題: バックアップが多すぎる

**解決策**:
- 古いバックアップは定期的に削除
- または、`data/transcripts_backup/`を`.gitignore`に追加

---

## 📝 おすすめの運用

1. **修正ルールを蓄積**
   - 誤字を発見したら、すぐ`corrections.json`に追加
   - チーム内で共有

2. **定期的に一括修正**
   - 新しいエピソードを追加したタイミングで実行
   - または、週1回など定期的に実行

3. **バックアップの管理**
   - 重要な変更の前にGitでコミット
   - バックアップフォルダは定期的にクリーンアップ

---

## 🎉 まとめ

- ✅ シンプルで使いやすい
- ✅ 修正ルールをJSONで管理
- ✅ 安全（バックアップ自動作成）
- ✅ ドライランで事前確認
- ✅ 特定ファイルのみ処理可能

